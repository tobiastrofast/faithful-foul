{"version":3,"sources":["../src/index.ts","../src/events.ts","../src/StereoButton.ts","../src/StereoPlugin.ts","../../../node_modules/three/examples/jsm/effects/StereoEffect.js"],"sourcesContent":["import { DEFAULTS, registerButton } from '@photo-sphere-viewer/core';\nimport * as events from './events';\nimport { StereoButton } from './StereoButton';\n\nDEFAULTS.lang[StereoButton.id] = 'Stereo view';\nregisterButton(StereoButton, 'caption:right');\n\nDEFAULTS.lang.stereoNotification = 'Tap anywhere to exit stereo view.';\nDEFAULTS.lang.pleaseRotate = 'Please rotate your device';\nDEFAULTS.lang.tapToContinue = '(or tap to continue)';\n\nexport { StereoPlugin } from './StereoPlugin';\nexport { events };\n","import { TypedEvent } from '@photo-sphere-viewer/core';\nimport type { StereoPlugin } from './StereoPlugin';\n\n/**\n * Triggered when the stereo view is enabled/disabled\n */\nexport class StereoUpdatedEvent extends TypedEvent<StereoPlugin> {\n    static override readonly type = 'stereo-updated';\n    override type: 'stereo-updated';\n\n    constructor(public readonly stereoEnabled: boolean) {\n        super(StereoUpdatedEvent.type);\n    }\n}\n\nexport type StereoPluginEvents = StereoUpdatedEvent;\n","import type { Navbar } from '@photo-sphere-viewer/core';\nimport { AbstractButton } from '@photo-sphere-viewer/core';\nimport { StereoUpdatedEvent } from './events';\nimport stereo from './icons/stereo.svg';\nimport type { StereoPlugin } from './StereoPlugin';\n\nexport class StereoButton extends AbstractButton {\n    static override readonly id = 'stereo';\n\n    private readonly plugin: StereoPlugin;\n\n    constructor(navbar: Navbar) {\n        super(navbar, {\n            className: 'psv-stereo-button',\n            icon: stereo,\n            hoverScale: true,\n            collapsable: true,\n            tabbable: true,\n        });\n\n        this.plugin = this.viewer.getPlugin('stereo');\n\n        if (this.plugin) {\n            this.plugin.addEventListener(StereoUpdatedEvent.type, this);\n        }\n    }\n\n    override destroy() {\n        if (this.plugin) {\n            this.plugin.removeEventListener(StereoUpdatedEvent.type, this);\n        }\n\n        super.destroy();\n    }\n\n    override isSupported() {\n        return !this.plugin ? false : { initial: false, promise: this.plugin.isSupported };\n    }\n\n    handleEvent(e: Event) {\n        if (e instanceof StereoUpdatedEvent) {\n            this.toggleActive(e.stereoEnabled);\n        }\n    }\n\n    /**\n     * Toggles stereo control\n     */\n    onClick() {\n        this.plugin.toggle();\n    }\n}\n","import type { CompassPlugin } from '@photo-sphere-viewer/compass-plugin';\nimport type { Viewer } from '@photo-sphere-viewer/core';\nimport { AbstractPlugin, events, PSVError, utils } from '@photo-sphere-viewer/core';\nimport type { GyroscopePlugin } from '@photo-sphere-viewer/gyroscope-plugin';\nimport type { MarkersPlugin } from '@photo-sphere-viewer/markers-plugin';\nimport { StereoEffect } from 'three/examples/jsm/effects/StereoEffect.js';\nimport { StereoPluginEvents, StereoUpdatedEvent } from './events';\nimport mobileRotateIcon from './icons/mobile-rotate.svg';\n\ninterface WakeLockSentinel {\n    release(): void;\n}\n\nconst ID_OVERLAY_PLEASE_ROTATE = 'pleaseRotate';\n\n/**\n * Adds stereo view on mobile devices\n */\nexport class StereoPlugin extends AbstractPlugin<StereoPluginEvents> {\n    static override readonly id = 'stereo';\n\n    private readonly state = {\n        enabled: false,\n        wakeLock: null as WakeLockSentinel,\n    };\n\n    private gyroscope: GyroscopePlugin;\n    private markers: MarkersPlugin;\n    private compass: CompassPlugin;\n\n    /**\n     * @internal\n     */\n    get isSupported(): Promise<boolean> {\n        return this.gyroscope.isSupported();\n    }\n\n    constructor(viewer: Viewer) {\n        super(viewer);\n    }\n\n    /**\n     * @internal\n     */\n    override init() {\n        super.init();\n\n        this.markers = this.viewer.getPlugin('markers');\n        this.compass = this.viewer.getPlugin('compass');\n        this.gyroscope = this.viewer.getPlugin('gyroscope');\n\n        if (!this.gyroscope) {\n            throw new PSVError('Stereo plugin requires the Gyroscope plugin');\n        }\n\n        this.viewer.addEventListener(events.StopAllEvent.type, this);\n        this.viewer.addEventListener(events.ClickEvent.type, this);\n    }\n\n    /**\n     * @internal\n     */\n    override destroy() {\n        this.viewer.removeEventListener(events.StopAllEvent.type, this);\n        this.viewer.removeEventListener(events.ClickEvent.type, this);\n\n        this.stop();\n\n        delete this.markers;\n        delete this.compass;\n        delete this.gyroscope;\n\n        super.destroy();\n    }\n\n    /**\n     * @internal\n     */\n    handleEvent(e: Event) {\n        if (e instanceof events.StopAllEvent || e instanceof events.ClickEvent) {\n            this.stop();\n        }\n    }\n\n    /**\n     * Checks if the stereo view is enabled\n     */\n    isEnabled(): boolean {\n        return this.state.enabled;\n    }\n\n    /**\n     * Enables the stereo view\n     * @description\n     *  - enables wake lock\n     *  - enables full screen\n     *  - starts gyroscope controle\n     *  - hides markers, navbar and panel\n     *  - instanciate the stereo effect\n     */\n    start(): Promise<void> {\n        // Need to be in the main event queue\n        this.viewer.enterFullscreen();\n        this.__startWakelock();\n        this.__lockOrientation();\n\n        return this.gyroscope.start('fast').then(\n            () => {\n                this.viewer.renderer.setCustomRenderer((renderer) => new StereoEffect(renderer));\n                this.state.enabled = true;\n\n                this.markers?.hideAllMarkers();\n                this.compass?.hide();\n                this.viewer.navbar.hide();\n                this.viewer.panel.hide();\n\n                this.dispatchEvent(new StereoUpdatedEvent(true));\n\n                this.viewer.notification.show({\n                    content: this.viewer.config.lang.stereoNotification,\n                    timeout: 3000,\n                });\n            },\n            () => {\n                this.__unlockOrientation();\n                this.__stopWakelock();\n                this.viewer.exitFullscreen();\n                return Promise.reject();\n            }\n        );\n    }\n\n    /**\n     * Disables the stereo view\n     */\n    stop() {\n        if (this.isEnabled()) {\n            this.viewer.renderer.setCustomRenderer(null);\n            this.state.enabled = false;\n\n            this.markers?.showAllMarkers();\n            this.compass?.show();\n            this.viewer.navbar.show();\n\n            this.__unlockOrientation();\n            this.__stopWakelock();\n            this.viewer.exitFullscreen();\n            this.gyroscope.stop();\n\n            this.dispatchEvent(new StereoUpdatedEvent(false));\n        }\n    }\n\n    /**\n     * Enables or disables the stereo view\n     */\n    toggle() {\n        if (this.isEnabled()) {\n            this.stop();\n        } else {\n            this.start();\n        }\n    }\n\n    /**\n     * Enables WakeLock\n     */\n    private __startWakelock() {\n        if ('wakeLock' in navigator) {\n            (navigator as any).wakeLock\n                .request('screen')\n                .then((wakeLock: WakeLockSentinel) => {\n                    this.state.wakeLock = wakeLock;\n                })\n                .catch(() => utils.logWarn('Cannot acquire WakeLock'));\n        } else {\n            utils.logWarn('WakeLock is not available');\n        }\n    }\n\n    /**\n     * Disables WakeLock\n     */\n    private __stopWakelock() {\n        if (this.state.wakeLock) {\n            this.state.wakeLock.release();\n            this.state.wakeLock = null;\n        }\n    }\n\n    /**\n     * Tries to lock the device in landscape or display a message\n     */\n    private __lockOrientation() {\n        let displayRotateMessageTimeout: ReturnType<typeof setTimeout>;\n\n        const displayRotateMessage = () => {\n            if (window.innerHeight > window.innerWidth) {\n                this.viewer.overlay.show({\n                    id: ID_OVERLAY_PLEASE_ROTATE,\n                    image: mobileRotateIcon,\n                    title: this.viewer.config.lang.pleaseRotate,\n                    text: this.viewer.config.lang.tapToContinue,\n                });\n            }\n\n            if (displayRotateMessageTimeout) {\n                clearTimeout(displayRotateMessageTimeout);\n                displayRotateMessageTimeout = null;\n            }\n        };\n\n        if (window.screen?.orientation) {\n            window.screen.orientation.lock('landscape').then(null, () => displayRotateMessage());\n            displayRotateMessageTimeout = setTimeout(() => displayRotateMessage(), 500);\n        } else {\n            displayRotateMessage();\n        }\n    }\n\n    /**\n     * Unlock the device orientation\n     */\n    private __unlockOrientation() {\n        if (window.screen?.orientation) {\n            window.screen.orientation.unlock();\n        } else {\n            this.viewer.overlay.hide(ID_OVERLAY_PLEASE_ROTATE);\n        }\n    }\n}\n","import {\n\tStereoCamera,\n\tVector2\n} from 'three';\n\nclass StereoEffect {\n\n\tconstructor( renderer ) {\n\n\t\tconst _stereo = new StereoCamera();\n\t\t_stereo.aspect = 0.5;\n\t\tconst size = new Vector2();\n\n\t\tthis.setEyeSeparation = function ( eyeSep ) {\n\n\t\t\t_stereo.eyeSep = eyeSep;\n\n\t\t};\n\n\t\tthis.setSize = function ( width, height ) {\n\n\t\t\trenderer.setSize( width, height );\n\n\t\t};\n\n\t\tthis.render = function ( scene, camera ) {\n\n\t\t\tif ( scene.matrixWorldAutoUpdate === true ) scene.updateMatrixWorld();\n\n\t\t\tif ( camera.parent === null && camera.matrixWorldAutoUpdate === true ) camera.updateMatrixWorld();\n\n\t\t\t_stereo.update( camera );\n\n\t\t\trenderer.getSize( size );\n\n\t\t\tif ( renderer.autoClear ) renderer.clear();\n\t\t\trenderer.setScissorTest( true );\n\n\t\t\trenderer.setScissor( 0, 0, size.width / 2, size.height );\n\t\t\trenderer.setViewport( 0, 0, size.width / 2, size.height );\n\t\t\trenderer.render( scene, _stereo.cameraL );\n\n\t\t\trenderer.setScissor( size.width / 2, 0, size.width / 2, size.height );\n\t\t\trenderer.setViewport( size.width / 2, 0, size.width / 2, size.height );\n\t\t\trenderer.render( scene, _stereo.cameraR );\n\n\t\t\trenderer.setScissorTest( false );\n\n\t\t};\n\n\t}\n\n}\n\nexport { StereoEffect };\n"],"mappings":";;;;;;;;;;;;AAAA,SAAS,UAAU,sBAAsB;;;ACAzC;AAAA;AAAA;AAAA;AAAA,SAAS,kBAAkB;AAMpB,IAAM,sBAAN,cAAiC,WAAyB;AAAA,EAI7D,YAA4B,eAAwB;AAChD,UAAM,oBAAmB,IAAI;AADL;AAAA,EAE5B;AACJ;AAPO,IAAM,qBAAN;AAAM,mBACgB,OAAO;;;ACNpC,SAAS,sBAAsB;;;;;;AAKxB,IAAM,eAAN,cAA2B,eAAe;AAAA,EAK7C,YAAY,QAAgB;AACxB,UAAM,QAAQ;AAAA,MACV,WAAW;AAAA,MACX,MAAM;AAAA,MACN,YAAY;AAAA,MACZ,aAAa;AAAA,MACb,UAAU;AAAA,IACd,CAAC;AAED,SAAK,SAAS,KAAK,OAAO,UAAU,QAAQ;AAE5C,QAAI,KAAK,QAAQ;AACb,WAAK,OAAO,iBAAiB,mBAAmB,MAAM,IAAI;AAAA,IAC9D;AAAA,EACJ;AAAA,EAES,UAAU;AACf,QAAI,KAAK,QAAQ;AACb,WAAK,OAAO,oBAAoB,mBAAmB,MAAM,IAAI;AAAA,IACjE;AAEA,UAAM,QAAQ;AAAA,EAClB;AAAA,EAES,cAAc;AACnB,WAAO,CAAC,KAAK,SAAS,QAAQ,EAAE,SAAS,OAAO,SAAS,KAAK,OAAO,YAAY;AAAA,EACrF;AAAA,EAEA,YAAY,GAAU;AAClB,QAAI,aAAa,oBAAoB;AACjC,WAAK,aAAa,EAAE,aAAa;AAAA,IACrC;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,UAAU;AACN,SAAK,OAAO,OAAO;AAAA,EACvB;AACJ;AA7Ca,aACgB,KAAK;;;ACLlC,SAAS,gBAAgB,QAAQ,UAAU,aAAa;;;ACFxD;AAAA,EACC;AAAA,EACA;AAAA,OACM;AAEP,IAAM,eAAN,MAAmB;AAAA,EAElB,YAAa,UAAW;AAEvB,UAAM,UAAU,IAAI,aAAa;AACjC,YAAQ,SAAS;AACjB,UAAM,OAAO,IAAI,QAAQ;AAEzB,SAAK,mBAAmB,SAAW,QAAS;AAE3C,cAAQ,SAAS;AAAA,IAElB;AAEA,SAAK,UAAU,SAAW,OAAO,QAAS;AAEzC,eAAS,QAAS,OAAO,MAAO;AAAA,IAEjC;AAEA,SAAK,SAAS,SAAW,OAAO,QAAS;AAExC,UAAK,MAAM,0BAA0B;AAAO,cAAM,kBAAkB;AAEpE,UAAK,OAAO,WAAW,QAAQ,OAAO,0BAA0B;AAAO,eAAO,kBAAkB;AAEhG,cAAQ,OAAQ,MAAO;AAEvB,eAAS,QAAS,IAAK;AAEvB,UAAK,SAAS;AAAY,iBAAS,MAAM;AACzC,eAAS,eAAgB,IAAK;AAE9B,eAAS,WAAY,GAAG,GAAG,KAAK,QAAQ,GAAG,KAAK,MAAO;AACvD,eAAS,YAAa,GAAG,GAAG,KAAK,QAAQ,GAAG,KAAK,MAAO;AACxD,eAAS,OAAQ,OAAO,QAAQ,OAAQ;AAExC,eAAS,WAAY,KAAK,QAAQ,GAAG,GAAG,KAAK,QAAQ,GAAG,KAAK,MAAO;AACpE,eAAS,YAAa,KAAK,QAAQ,GAAG,GAAG,KAAK,QAAQ,GAAG,KAAK,MAAO;AACrE,eAAS,OAAQ,OAAO,QAAQ,OAAQ;AAExC,eAAS,eAAgB,KAAM;AAAA,IAEhC;AAAA,EAED;AAED;;;;;;ADvCA,IAAM,2BAA2B;AAK1B,IAAM,eAAN,cAA2B,eAAmC;AAAA,EAmBjE,YAAY,QAAgB;AACxB,UAAM,MAAM;AAjBhB,SAAiB,QAAQ;AAAA,MACrB,SAAS;AAAA,MACT,UAAU;AAAA,IACd;AAAA,EAeA;AAAA;AAAA;AAAA;AAAA,EANA,IAAI,cAAgC;AAChC,WAAO,KAAK,UAAU,YAAY;AAAA,EACtC;AAAA;AAAA;AAAA;AAAA,EASS,OAAO;AACZ,UAAM,KAAK;AAEX,SAAK,UAAU,KAAK,OAAO,UAAU,SAAS;AAC9C,SAAK,UAAU,KAAK,OAAO,UAAU,SAAS;AAC9C,SAAK,YAAY,KAAK,OAAO,UAAU,WAAW;AAElD,QAAI,CAAC,KAAK,WAAW;AACjB,YAAM,IAAI,SAAS,6CAA6C;AAAA,IACpE;AAEA,SAAK,OAAO,iBAAiB,OAAO,aAAa,MAAM,IAAI;AAC3D,SAAK,OAAO,iBAAiB,OAAO,WAAW,MAAM,IAAI;AAAA,EAC7D;AAAA;AAAA;AAAA;AAAA,EAKS,UAAU;AACf,SAAK,OAAO,oBAAoB,OAAO,aAAa,MAAM,IAAI;AAC9D,SAAK,OAAO,oBAAoB,OAAO,WAAW,MAAM,IAAI;AAE5D,SAAK,KAAK;AAEV,WAAO,KAAK;AACZ,WAAO,KAAK;AACZ,WAAO,KAAK;AAEZ,UAAM,QAAQ;AAAA,EAClB;AAAA;AAAA;AAAA;AAAA,EAKA,YAAY,GAAU;AAClB,QAAI,aAAa,OAAO,gBAAgB,aAAa,OAAO,YAAY;AACpE,WAAK,KAAK;AAAA,IACd;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,YAAqB;AACjB,WAAO,KAAK,MAAM;AAAA,EACtB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAWA,QAAuB;AAEnB,SAAK,OAAO,gBAAgB;AAC5B,SAAK,gBAAgB;AACrB,SAAK,kBAAkB;AAEvB,WAAO,KAAK,UAAU,MAAM,MAAM,EAAE;AAAA,MAChC,MAAM;AACF,aAAK,OAAO,SAAS,kBAAkB,CAAC,aAAa,IAAI,aAAa,QAAQ,CAAC;AAC/E,aAAK,MAAM,UAAU;AAErB,aAAK,SAAS,eAAe;AAC7B,aAAK,SAAS,KAAK;AACnB,aAAK,OAAO,OAAO,KAAK;AACxB,aAAK,OAAO,MAAM,KAAK;AAEvB,aAAK,cAAc,IAAI,mBAAmB,IAAI,CAAC;AAE/C,aAAK,OAAO,aAAa,KAAK;AAAA,UAC1B,SAAS,KAAK,OAAO,OAAO,KAAK;AAAA,UACjC,SAAS;AAAA,QACb,CAAC;AAAA,MACL;AAAA,MACA,MAAM;AACF,aAAK,oBAAoB;AACzB,aAAK,eAAe;AACpB,aAAK,OAAO,eAAe;AAC3B,eAAO,QAAQ,OAAO;AAAA,MAC1B;AAAA,IACJ;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,OAAO;AACH,QAAI,KAAK,UAAU,GAAG;AAClB,WAAK,OAAO,SAAS,kBAAkB,IAAI;AAC3C,WAAK,MAAM,UAAU;AAErB,WAAK,SAAS,eAAe;AAC7B,WAAK,SAAS,KAAK;AACnB,WAAK,OAAO,OAAO,KAAK;AAExB,WAAK,oBAAoB;AACzB,WAAK,eAAe;AACpB,WAAK,OAAO,eAAe;AAC3B,WAAK,UAAU,KAAK;AAEpB,WAAK,cAAc,IAAI,mBAAmB,KAAK,CAAC;AAAA,IACpD;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,SAAS;AACL,QAAI,KAAK,UAAU,GAAG;AAClB,WAAK,KAAK;AAAA,IACd,OAAO;AACH,WAAK,MAAM;AAAA,IACf;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKQ,kBAAkB;AACtB,QAAI,cAAc,WAAW;AACzB,MAAC,UAAkB,SACd,QAAQ,QAAQ,EAChB,KAAK,CAAC,aAA+B;AAClC,aAAK,MAAM,WAAW;AAAA,MAC1B,CAAC,EACA,MAAM,MAAM,MAAM,QAAQ,yBAAyB,CAAC;AAAA,IAC7D,OAAO;AACH,YAAM,QAAQ,2BAA2B;AAAA,IAC7C;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKQ,iBAAiB;AACrB,QAAI,KAAK,MAAM,UAAU;AACrB,WAAK,MAAM,SAAS,QAAQ;AAC5B,WAAK,MAAM,WAAW;AAAA,IAC1B;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKQ,oBAAoB;AACxB,QAAI;AAEJ,UAAM,uBAAuB,MAAM;AAC/B,UAAI,OAAO,cAAc,OAAO,YAAY;AACxC,aAAK,OAAO,QAAQ,KAAK;AAAA,UACrB,IAAI;AAAA,UACJ,OAAO;AAAA,UACP,OAAO,KAAK,OAAO,OAAO,KAAK;AAAA,UAC/B,MAAM,KAAK,OAAO,OAAO,KAAK;AAAA,QAClC,CAAC;AAAA,MACL;AAEA,UAAI,6BAA6B;AAC7B,qBAAa,2BAA2B;AACxC,sCAA8B;AAAA,MAClC;AAAA,IACJ;AAEA,QAAI,OAAO,QAAQ,aAAa;AAC5B,aAAO,OAAO,YAAY,KAAK,WAAW,EAAE,KAAK,MAAM,MAAM,qBAAqB,CAAC;AACnF,oCAA8B,WAAW,MAAM,qBAAqB,GAAG,GAAG;AAAA,IAC9E,OAAO;AACH,2BAAqB;AAAA,IACzB;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKQ,sBAAsB;AAC1B,QAAI,OAAO,QAAQ,aAAa;AAC5B,aAAO,OAAO,YAAY,OAAO;AAAA,IACrC,OAAO;AACH,WAAK,OAAO,QAAQ,KAAK,wBAAwB;AAAA,IACrD;AAAA,EACJ;AACJ;AApNa,aACgB,KAAK;;;AHflC,SAAS,KAAK,aAAa,EAAE,IAAI;AACjC,eAAe,cAAc,eAAe;AAE5C,SAAS,KAAK,qBAAqB;AACnC,SAAS,KAAK,eAAe;AAC7B,SAAS,KAAK,gBAAgB;","names":[]}